
<!DOCTYPE html>
<html lang="en-us">

<head>

    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <meta property="og:title" content=" Istio, Cert-Manager and Let&#39;s Encrypt April &#39;20 &middot;  The Nexus" />
    <meta property="og:site_name" content="The Nexus" />
    <meta property="og:url" content="https://zteo.com/posts/istio-and-cert-manager-and-lets-encrypt/" />

    
    <meta property="og:type" content="article" />
    <meta property="og:article:published_time" content="2020-04-29T10:54:24&#43;02:00" />
    <meta property="og:article:tag" content="kubernetes" />
    <meta property="og:article:tag" content="service mesh" />
    

    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@" />
    <meta name="twitter:creator" content="@" />
    <meta name="twitter:title" content="Istio, Cert-Manager and Let&#39;s Encrypt April &#39;20" />
    
    <meta name="twitter:image" content="https://zteo.com/images/istiok8s.jpg" />
    
    <meta name="twitter:description" content="What is this? It is very easy to find blog posts and articles explaining how to make some of these components work together. They are also completely outdated.
It is not their fault: Kubernetes moves fast, Istio&rsquo;s development seems to move even faster, and cert-manager breaks backward compatibility. Chances are, by the time you read it it will be too late!
Anyway, in a futile attempt to remain somewhat ahead of the curve, this article was written for Istio-1." />
    <meta name="twitter:url" content="https://zteo.com/posts/istio-and-cert-manager-and-lets-encrypt/" />
    

    <title> Istio, Cert-Manager and Let&#39;s Encrypt April &#39;20 &middot;  The Nexus</title>

    <link rel="preload" href="https://zteo.com//css/fontawesome-all.min.css" as="style" />
    <link rel="preload" href="https://zteo.com//js/main.js" as="script" />
    <link rel="preload" href="https://zteo.com//css/main.css" as="style" />
    
    <link href="/mermaid/mermaid.cfr.css?1636583495" type="text/css" rel="stylesheet" />
    
    
    <link rel="webmention" href="https://webmention.io/zteo.com/webmention" />
    <link rel="pingback" href="https://webmention.io/zteo.com/xmlrpc" />
    
    
    <link rel="me" href="https://github.com/fusion" />
    <link rel="me" href="https://twitter.com/chrisfr" />
    
    
    <link rel="preload" href="https://zteo.com//css/cfr.css" as="style" />
    <link rel="stylesheet" href="https://zteo.com//css/main.css">
    <link rel="stylesheet" href="https://zteo.com//css/pure-min.css">
    <link rel="preload" href="https://zteo.com//js/basicLightbox.min.js" as="script" />
    <link rel="stylesheet" href="https://zteo.com//css/basicLightbox.min.css">
    <link rel="stylesheet" href="https://zteo.com//css/fontawesome-all.min.css" />
    <link rel="stylesheet" href="https://zteo.com//css/cfr.css">
    <link rel="stylesheet" href="https://zteo.com//css/syntax.css">
    
    
    


    
    <meta name="description" content="" />
    

    
    <meta name="p:domain_verify" content=""/>
    

    <meta name="HandheldFriendly" content="True" />
    <meta name="MobileOptimized" content="320" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    
    

    
    <link href="https://zteo.com/index.xml" rel="alternate" type="application/rss+xml" title="The Nexus" />
    

    
    <link rel="canonical" href="https://zteo.com/posts/istio-and-cert-manager-and-lets-encrypt/" />

    
    <script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "mainEntityOfPage": {
          "@type": "WebPage",
          "@id": "https:\/\/zteo.com\/posts\/istio-and-cert-manager-and-lets-encrypt\/"
        },
        "headline": "Istio, Cert-Manager and Let\u0027s Encrypt April \u002720",
        "description": "",
        "author": {
            "@type": "Person",
            "name": " ",
            "url": "http://profiles.google.com/?rel=author",
            "image": {
              "@type": "ImageObject",
              "url": "https:",
              "height": 80,
              "width": 80
            }
        },
        "publisher": {
          "@type": "Organization",
          "@id": "https:\/\/zteo.com\/",
          "name": "The Nexus",
          "url": "https:\/\/zteo.com\/",
          "logo": {
            "@type": "ImageObject",
            "url": "https:",
            "height": 80,
            "width": 80
          }
        },
        "image": {
          "@type": "ImageObject",
          "url": "https:\/\/zteo.com\/istiok8s.jpg",
          "height": 133,
          "width": 200
        },
        "datePublished": "2020-04-29",
        "dateModified": "2020-04-29",
        "wordCount":  1548 ,
        "keywords": "[\"kubernetes\",\"service mesh\"]" 
    }
    </script>
    

    
    <script type="text/javascript">
        
        
    </script>
    

    <script type="text/javascript">
        var config = {
            baseUrl: "https:\/\/zteo.com\/"
        };
    </script>

</head>
<body class="home-template">
<div id="loader-wrapper">
    <div id="loader"></div>
</div>
<section id="wrapper" style="display: none;">
    <div id="ajax-container">
        <nav id="nav" class="nav">
            <div class="nav-logo">
                <a href="https://zteo.com/">
                    
                    The Nexus
                    
                </a>
            </div>

            <nav id="nav2" role="navigation">
                <a href="#nav" title="Show navigation">Show navigation</a>
                <a href="#" title="Hide navigation">Hide navigation</a>
                <ul class="clearfix">
                    <li><a href="https://zteo.com/">BLOG</a></li>
                    <li>
                        <a href="https://zteo.com/meta/about" aria-haspopup="true"><span>ABOUT</span></a>
                        <ul>
                            <li><a href="https://zteo.com/meta/egosurfing">Ego Surfing</a></li>
                        </ul>
                    </li>
                    <li>
                        <a href="https://zteo.com/projects/projects-list" aria-haspopup="true"><span>PROJECTS</span></a>
                        <ul>
                            <li><a href="https://zteo.com/projects/n2">n2</a></li>
                            <li><a href="https://zteo.com/projects/s2ajax">S2ajax</a></li>
                            <li><a href="https://zteo.com/projects/condo">Condo</a></li>
                            <li><a href="https://zteo.com/projects/ezedit">ezEdit</a></li>
                            <li><a href="https://zteo.com/projects/freeblog">FreeBlog - Air</a></li>
                            <li><a href="https://zteo.com/projects/tooredo-alpha">Tooredo Alpha</a></li>
                            <li><a href="https://zteo.com/projects/tools">Tools</a></li>
                            <li><a href="https://zteo.com/projects/journler-again">Journlr, Again!</a></li>
                        </ul>
                    </li>
                </ul>
            </nav>


            <div id="main-menu" class="nav-menu">
                
                
                <a id="search-button" onclick="$('#search-form').toggle();" title="Search"><i class="fa fa-search"></i></a>
                <form id="search-form" method="get" role="search" action="https://google.com/search">
                    <input type="hidden" name="as_sitesearch" value="https://zteo.com/">
                    <input type="text" name="q" maxlength="255" placeholder="Search..." class="form-control">
                    <input type="submit" value="Search">
                </form>
                
                
                
                
            </div>
        </nav>


<style>
@media(min-width:1024px) {
	main {
		display: grid;
		grid-template-columns: 100% 100%;
	}
}

</style>

<main class="content" role="main">
    <article class="post post-with-bg">
        <div class="inner">

            <div id="push">

                <header class="post-header">
                
                    <span class="post-meta">
                        <span class="post-date">29 Apr 2020</span> <span class="reading-time">| <span class="estimated-reading-time">8 min.</span> (<span class="word-count">1548</span> words)</span></span>
                    </span>
                <div class="clear"></div>
                
                <h1 class="post-title">Istio, Cert-Manager and Let&#39;s Encrypt April &#39;20</h1>
              </header>

              <section class="post-content">
                

                
                
                


                
                    <main>
                        <div class="content blog-content">
                        <h1 id="what-is-this">What is this?</h1>
<p>It is very easy to find blog posts and articles explaining how to make some of these components work together. They are also completely outdated.</p>
<p>It is not their fault: Kubernetes moves fast, Istio&rsquo;s development seems to move even faster, and cert-manager breaks backward compatibility. Chances are, by the time you read it it will be too late!</p>
<p>Anyway, in a futile attempt to remain somewhat ahead of the curve, this article was written for Istio-1.6.0-alpha.2. It is fresh!</p>
<p>Feel free to hop straight to the &ldquo;Tutorial&rdquo; section, if that&rsquo;s your thing.</p>
<h1 id="a-few-useful-concepts-before-we-get-started">A few useful concepts before we get started</h1>
<h2 id="gateways-and-ingress">&ldquo;Gateways&rdquo; and &ldquo;Ingress&rdquo;</h2>
<p>Gateways and Ingress are not a 100% match to Kubernetes' defitinions, so some expectations may be plain wrong. Keep that in mind!</p>
<h2 id="setting-up">Setting up</h2>
<div class="LinkPreview">
    <a href="https://istio.io/docs/setup/getting-started/#download">
    <img src="/images/istio-logo.png">
      <div class="content">
      <h4>
          Istio
      </h4>
      <div class="description">
          Getting Started
      </div>
    </div>
  </a>
</div>

<p>It is generally recommended to start with the demo manifest:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">cd</span> istio-1.6.0-alpha.2
<span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="nv">$PWD</span>/bin:<span class="nv">$PATH</span>
istioctl manifest apply --set <span class="nv">profile</span><span class="o">=</span>demo
</code></pre></div><p>Let&rsquo;s have a quick looksie:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">kubectl get svc -n istio-system
</code></pre></div><p>At this stage, we could easily uninstall istio:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">istioctl manifest generate --set <span class="nv">profile</span><span class="o">=</span>demo <span class="p">|</span> kubectl delete -f -
<span class="c1"># and re-install...</span>
</code></pre></div><p>Moving on.</p>
<h2 id="using-a-load-balancer-spoiler-i-will-not">Using a load balancer (spoiler: I will not)</h2>
<p>With no load balancer, ingress access  can be&hellip; challenging.</p>
<p>Let&rsquo;s say we are using AWS EKS, for instance. This is how we would configure it:</p>
<p><a href="https://github.com/kubernetes/cloud-provider-aws#readme">kubernetes/cloud-provider-aws</a></p>
<p>Security (IAM):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;Version&#34;</span><span class="p">:</span> <span class="s2">&#34;2012-10-17&#34;</span><span class="p">,</span>
  <span class="nt">&#34;Statement&#34;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&#34;Effect&#34;</span><span class="p">:</span> <span class="s2">&#34;Allow&#34;</span><span class="p">,</span>
      <span class="nt">&#34;Action&#34;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&#34;autoscaling:DescribeAutoScalingGroups&#34;</span><span class="p">,</span>
        <span class="s2">&#34;autoscaling:DescribeLaunchConfigurations&#34;</span><span class="p">,</span>
        <span class="s2">&#34;autoscaling:DescribeTags&#34;</span><span class="p">,</span>
        <span class="s2">&#34;ec2:DescribeInstances&#34;</span><span class="p">,</span>
        <span class="s2">&#34;ec2:DescribeRegions&#34;</span><span class="p">,</span>
        <span class="s2">&#34;ec2:DescribeRouteTables&#34;</span><span class="p">,</span>
        <span class="s2">&#34;ec2:DescribeSecurityGroups&#34;</span><span class="p">,</span>
        <span class="s2">&#34;ec2:DescribeSubnets&#34;</span><span class="p">,</span>
        <span class="s2">&#34;ec2:DescribeVolumes&#34;</span><span class="p">,</span>
        <span class="s2">&#34;ec2:CreateSecurityGroup&#34;</span><span class="p">,</span>
        <span class="s2">&#34;ec2:CreateTags&#34;</span><span class="p">,</span>
        <span class="s2">&#34;ec2:CreateVolume&#34;</span><span class="p">,</span>
        <span class="s2">&#34;ec2:ModifyInstanceAttribute&#34;</span><span class="p">,</span>
        <span class="s2">&#34;ec2:ModifyVolume&#34;</span><span class="p">,</span>
        <span class="s2">&#34;ec2:AttachVolume&#34;</span><span class="p">,</span>
        <span class="s2">&#34;ec2:AuthorizeSecurityGroupIngress&#34;</span><span class="p">,</span>
        <span class="s2">&#34;ec2:CreateRoute&#34;</span><span class="p">,</span>
        <span class="s2">&#34;ec2:DeleteRoute&#34;</span><span class="p">,</span>
        <span class="s2">&#34;ec2:DeleteSecurityGroup&#34;</span><span class="p">,</span>
        <span class="s2">&#34;ec2:DeleteVolume&#34;</span><span class="p">,</span>
        <span class="s2">&#34;ec2:DetachVolume&#34;</span><span class="p">,</span>
        <span class="s2">&#34;ec2:RevokeSecurityGroupIngress&#34;</span><span class="p">,</span>
        <span class="s2">&#34;ec2:DescribeVpcs&#34;</span><span class="p">,</span>
        <span class="s2">&#34;elasticloadbalancing:AddTags&#34;</span><span class="p">,</span>
        <span class="s2">&#34;elasticloadbalancing:AttachLoadBalancerToSubnets&#34;</span><span class="p">,</span>
        <span class="s2">&#34;elasticloadbalancing:ApplySecurityGroupsToLoadBalancer&#34;</span><span class="p">,</span>
        <span class="s2">&#34;elasticloadbalancing:CreateLoadBalancer&#34;</span><span class="p">,</span>
        <span class="s2">&#34;elasticloadbalancing:CreateLoadBalancerPolicy&#34;</span><span class="p">,</span>
        <span class="s2">&#34;elasticloadbalancing:CreateLoadBalancerListeners&#34;</span><span class="p">,</span>
        <span class="s2">&#34;elasticloadbalancing:ConfigureHealthCheck&#34;</span><span class="p">,</span>
        <span class="s2">&#34;elasticloadbalancing:DeleteLoadBalancer&#34;</span><span class="p">,</span>
        <span class="s2">&#34;elasticloadbalancing:DeleteLoadBalancerListeners&#34;</span><span class="p">,</span>
        <span class="s2">&#34;elasticloadbalancing:DescribeLoadBalancers&#34;</span><span class="p">,</span>
        <span class="s2">&#34;elasticloadbalancing:DescribeLoadBalancerAttributes&#34;</span><span class="p">,</span>
        <span class="s2">&#34;elasticloadbalancing:DetachLoadBalancerFromSubnets&#34;</span><span class="p">,</span>
        <span class="s2">&#34;elasticloadbalancing:DeregisterInstancesFromLoadBalancer&#34;</span><span class="p">,</span>
        <span class="s2">&#34;elasticloadbalancing:ModifyLoadBalancerAttributes&#34;</span><span class="p">,</span>
        <span class="s2">&#34;elasticloadbalancing:RegisterInstancesWithLoadBalancer&#34;</span><span class="p">,</span>
        <span class="s2">&#34;elasticloadbalancing:SetLoadBalancerPoliciesForBackendServer&#34;</span><span class="p">,</span>
        <span class="s2">&#34;elasticloadbalancing:AddTags&#34;</span><span class="p">,</span>
        <span class="s2">&#34;elasticloadbalancing:CreateListener&#34;</span><span class="p">,</span>
        <span class="s2">&#34;elasticloadbalancing:CreateTargetGroup&#34;</span><span class="p">,</span>
        <span class="s2">&#34;elasticloadbalancing:DeleteListener&#34;</span><span class="p">,</span>
        <span class="s2">&#34;elasticloadbalancing:DeleteTargetGroup&#34;</span><span class="p">,</span>
        <span class="s2">&#34;elasticloadbalancing:DescribeListeners&#34;</span><span class="p">,</span>
        <span class="s2">&#34;elasticloadbalancing:DescribeLoadBalancerPolicies&#34;</span><span class="p">,</span>
        <span class="s2">&#34;elasticloadbalancing:DescribeTargetGroups&#34;</span><span class="p">,</span>
        <span class="s2">&#34;elasticloadbalancing:DescribeTargetHealth&#34;</span><span class="p">,</span>
        <span class="s2">&#34;elasticloadbalancing:ModifyListener&#34;</span><span class="p">,</span>
        <span class="s2">&#34;elasticloadbalancing:ModifyTargetGroup&#34;</span><span class="p">,</span>
        <span class="s2">&#34;elasticloadbalancing:RegisterTargets&#34;</span><span class="p">,</span>
        <span class="s2">&#34;elasticloadbalancing:DeregisterTargets&#34;</span><span class="p">,</span>
        <span class="s2">&#34;elasticloadbalancing:SetLoadBalancerPoliciesOfListener&#34;</span><span class="p">,</span>
        <span class="s2">&#34;iam:CreateServiceLinkedRole&#34;</span><span class="p">,</span>
        <span class="s2">&#34;kms:DescribeKey&#34;</span>
      <span class="p">],</span>
      <span class="nt">&#34;Resource&#34;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&#34;*&#34;</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</code></pre></div><p>Node policy:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
      <span class="nt">&#34;Version&#34;</span><span class="p">:</span> <span class="s2">&#34;2012-10-17&#34;</span><span class="p">,</span>
      <span class="nt">&#34;Statement&#34;</span><span class="p">:</span> <span class="p">[</span>
          <span class="p">{</span>
              <span class="nt">&#34;Effect&#34;</span><span class="p">:</span> <span class="s2">&#34;Allow&#34;</span><span class="p">,</span>
              <span class="nt">&#34;Action&#34;</span><span class="p">:</span> <span class="p">[</span>
                  <span class="s2">&#34;ec2:DescribeInstances&#34;</span><span class="p">,</span>
                  <span class="s2">&#34;ec2:DescribeRegions&#34;</span><span class="p">,</span>
                  <span class="s2">&#34;ecr:GetAuthorizationToken&#34;</span><span class="p">,</span>
                  <span class="s2">&#34;ecr:BatchCheckLayerAvailability&#34;</span><span class="p">,</span>
                  <span class="s2">&#34;ecr:GetDownloadUrlForLayer&#34;</span><span class="p">,</span>
                  <span class="s2">&#34;ecr:GetRepositoryPolicy&#34;</span><span class="p">,</span>
                  <span class="s2">&#34;ecr:DescribeRepositories&#34;</span><span class="p">,</span>
                  <span class="s2">&#34;ecr:ListImages&#34;</span><span class="p">,</span>
                  <span class="s2">&#34;ecr:BatchGetImage&#34;</span>
              <span class="p">],</span>
              <span class="nt">&#34;Resource&#34;</span><span class="p">:</span> <span class="s2">&#34;*&#34;</span>
          <span class="p">}</span> 
      <span class="p">]</span>
  <span class="p">}</span>
</code></pre></div><p>The node name is the instance&rsquo;s private DNS name.</p>
<p>Beware! If you are running Kubernetes on AWS/EC2 rather than leveraging their proprietary container solution, this external load balancer will not be very helpful.</p>
<p>Similarly, installing a bare metal load balancer (metal lb) will not help as it will not have access to a pool of IP addresses.</p>
<h2 id="node-port-approach">Node Port approach</h2>
<p>So, we installed our manifest. Looks like our gateway will be sitting there, not getting an external IP address.</p>
<p>Let&rsquo;s retrieve our ports and usable node IP:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">export</span> <span class="nv">INGRESS_PORT</span><span class="o">=</span><span class="se">\
</span><span class="se"></span><span class="k">$(</span>kubectl -n istio-system get service istio-ingressgateway <span class="se">\
</span><span class="se"></span>-o <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.spec.ports[?(@.name==&#34;http2&#34;)].nodePort}&#39;</span><span class="k">)</span>
<span class="nb">export</span> <span class="nv">SECURE_INGRESS_PORT</span><span class="o">=</span><span class="se">\
</span><span class="se"></span><span class="k">$(</span>kubectl -n istio-system get service istio-ingressgateway <span class="se">\
</span><span class="se"></span>-o <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.spec.ports[?(@.name==&#34;https&#34;)].nodePort}&#39;</span><span class="k">)</span>
<span class="nb">export</span> <span class="nv">INGRESS_HOST</span><span class="o">=</span><span class="se">\
</span><span class="se"></span><span class="k">$(</span>kubectl get po -l <span class="nv">istio</span><span class="o">=</span>ingressgateway -n istio-system <span class="se">\
</span><span class="se"></span>-o <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.items[0].status.hostIP}&#39;</span><span class="k">)</span>
</code></pre></div><h2 id="sidecar-injection">Sidecar Injection</h2>
<p>By default, if the matching namespace is correctly labeled, then istio will perform the injection:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">kubectl label ns httpbin istio-injection<span class="o">=</span>enabled
</code></pre></div><p>But we may wish to perform the injection on a more fine grained level, in an unlabeled namespace. So, let&rsquo;s instead have istio modify our definition file on the fly:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">kubectl apply -f &lt;<span class="o">(</span>istioctl kube-inject -f istio-httpbin.yaml<span class="o">)</span>
</code></pre></div><p>Test it (no public route yet):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">curl -I -HHost:web.yoursite.com http://<span class="nv">$INGRESS_HOST</span>:<span class="nv">$INGRESS_PORT</span>/headers
curl -I -HHost:web.yoursite.com http://<span class="nv">$INGRESS_HOST</span>:<span class="nv">$INGRESS_PORT</span>/status/201pro
</code></pre></div><p>So, once the injector is there, things start being properly routed. Yeah.</p>
<h2 id="the-ingress-in-the-ingress">The ingress in the ingress</h2>
<p>So&hellip; OK? No. Not OK. We are still using a bogus port. Not proper 80. What&rsquo;s next, then? Redirections?</p>
<p>For instance:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">sudo socat tcp-listen:80,reuseaddr,fork tcp:<span class="nv">$INGRESS_HOST</span>:<span class="nv">$INGRESS_PORT</span> <span class="p">&amp;</span>
sudo socat tcp-listen:443,reuseaddr,fork tcp:<span class="nv">$INGRESS_HOST</span>:<span class="nv">$SECURE_INGRESS_PORT</span> <span class="p">&amp;</span>
</code></pre></div><p>Do I recommend this? Not really. Am I going to use it for the purpose of this already complex tutorial? You bet!</p>
<h2 id="what-changed-in-1516">What changed in 1.5/1.6&hellip;?</h2>
<p>When configuring our istio profile:</p>
<p><code>--set values.gateways.istio-ingressgateway.sds.enabled=true</code> doesn&rsquo;t change anything</p>
<p><code>--set values.global.k8sIngress.enabled=true</code> enables an auto-generated k8s ingress gateway â€” this is a LEGACY ingress we do not want anymore. In fact, in 1.6 this option is gone.</p>
<h1 id="tutorial">Tutorial</h1>
<p>In this tutorial, we are going to setup the now well known bookinfo application, demonstrating Istio&rsquo;s mesh management capabilities:</p>
<p><img src="/images/bookinfo.png" alt="/images/bookinfo.png"  />
</p>
<p>Note: Namespace visibility is very important. If you do not pay attention to it, you will spend hours of hair pulling over this &ldquo;almost working&rdquo; situation.</p>
<p><img src="/images/istio1.png" alt="/images/istio1.png"  />
</p>
<h2 id="cert-manager">cert-manager</h2>
<p>Let&rsquo;s install cert-manager.</p>
<p>It is possible that the webhook pod will not come up and <code>describe</code> will reveal that it could not find &lsquo;cert-manager-webhook-tls&rsquo;
In this case, give it a few minutes, then run the command again.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">kubectl apply <span class="se">\
</span><span class="se"></span>	-f https://github.com/jetstack/cert-manager/releases/download/v0.14.2/cert-manager.yaml
kubectl get pods --namespace cert-manager
<span class="c1"># Still missing secret after several minutes? Apply again!!!</span>
</code></pre></div><p>Optional: test cert-manager with a self-signed certificate</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">cat <span class="s">&lt;&lt;EOF &gt; test-resources.yaml
</span><span class="s">apiVersion: v1
</span><span class="s">kind: Namespace
</span><span class="s">metadata:
</span><span class="s">  name: cert-manager-test
</span><span class="s">---
</span><span class="s">apiVersion: cert-manager.io/v1alpha2
</span><span class="s">kind: Issuer
</span><span class="s">metadata:
</span><span class="s">  name: test-selfsigned
</span><span class="s">  namespace: cert-manager-test
</span><span class="s">spec:
</span><span class="s">  selfSigned: {}
</span><span class="s">---
</span><span class="s">apiVersion: cert-manager.io/v1alpha2
</span><span class="s">kind: Certificate
</span><span class="s">metadata:
</span><span class="s">  name: selfsigned-cert
</span><span class="s">  namespace: cert-manager-test
</span><span class="s">spec:
</span><span class="s">  dnsNames:
</span><span class="s">    - example.com
</span><span class="s">  secretName: selfsigned-cert-tls
</span><span class="s">  issuerRef:
</span><span class="s">    name: test-selfsigned
</span><span class="s">EOF</span>
kubectl apply -f test-resources.yaml
kubectl describe certificate -n cert-manager-test
kubectl delete -f test-resources.yaml
</code></pre></div><p>We are using the DNS-01 ACME challenge.</p>
<h2 id="letsencrypt-and-cloudflare">Letsencrypt and Cloudflare</h2>
<p>Therefore, using the Cloudflare control panel, we create a new token.</p>
<p>Right now, a major limitation is that we need to first list all the zones to retrieve zone id; this requires a token with Read access to all zones; however, if we open the token to all zones it can also &lsquo;Edit&rsquo; all DNS entries. In future maybe we should use two tokens, one for each operation.</p>
<p>Anyway, for now, bottom line is: Read all Zones, Edit all DNS entries. Sigh.</p>
<p>Let&rsquo;s store our token.</p>
<p>When referencing a Secret resource in ClusterIssuer resources (eg apiTokenKeySecretRef) the Secret needs to be in the same namespace as the cert-manager controller pod!!!</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">cat <span class="s">&lt;&lt;EOF &gt; acme-store-token.yaml
</span><span class="s">apiVersion: v1
</span><span class="s">kind: Secret
</span><span class="s">metadata:
</span><span class="s">  name: cloudflare-api-token-secret
</span><span class="s">  namespace: cert-manager
</span><span class="s">type: Opaque
</span><span class="s">stringData:
</span><span class="s">  api-token: your-cloudflare-token
</span><span class="s">EOF</span>

kubectl apply -f acme-store-token.yaml
</code></pre></div><p>Now, create a cluster issuer.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">cat <span class="s">&lt;&lt;EOF &gt; acme-issuer.yaml
</span><span class="s">apiVersion: cert-manager.io/v1alpha2
</span><span class="s">kind: ClusterIssuer
</span><span class="s">metadata:
</span><span class="s">  name: cloudflare-letsencrypt-prod
</span><span class="s">  namespace: cert-manager
</span><span class="s">spec:
</span><span class="s">  acme:
</span><span class="s">    email: you@yoursite.com
</span><span class="s">    server: https://acme-v02.api.letsencrypt.org/directory
</span><span class="s">    privateKeySecretRef:
</span><span class="s">      name: acme-issuer-account-key
</span><span class="s">    solvers:
</span><span class="s">    - dns01:
</span><span class="s">        cloudflare:
</span><span class="s">          email: you@yoursite.com
</span><span class="s">          apiTokenSecretRef:
</span><span class="s">            name: cloudflare-api-token-secret
</span><span class="s">            key: api-token
</span><span class="s">EOF</span>

kubectl apply -f acme-issuer.yaml
</code></pre></div><p>Optional: test cert-manager with the ACME challenge</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">cat <span class="s">&lt;&lt;EOF &gt; test-resources-acme.yaml
</span><span class="s">apiVersion: v1
</span><span class="s">kind: Namespace
</span><span class="s">metadata:
</span><span class="s">  name: cert-manager-test
</span><span class="s">---
</span><span class="s">apiVersion: cert-manager.io/v1alpha2
</span><span class="s">kind: Certificate
</span><span class="s">metadata:
</span><span class="s">  name: acme-cert
</span><span class="s">  namespace: default
</span><span class="s">spec:
</span><span class="s">  dnsNames:
</span><span class="s">    - web.yoursite.com
</span><span class="s">  secretName: acme-web-yoursite-secret
</span><span class="s">  issuerRef:
</span><span class="s">    name: cloudflare-letsencrypt-prod
</span><span class="s">    kind: ClusterIssuer
</span><span class="s">EOF</span>

kubectl apply -f test-resources-acme.yaml
</code></pre></div><h2 id="hello-istio">Hello, istio</h2>
<p>We can now setup a default istio configuration</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">istioctl manifest apply
kubectl label namespace default istio-injection<span class="o">=</span>enabled
</code></pre></div><p>Let&rsquo;s also install the bookinfo sample</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml
</code></pre></div><p>Let&rsquo;s get a usable certificate for this app</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">cat <span class="s">&lt;&lt;EOF &gt; web-yoursite-com-cert.yaml
</span><span class="s">apiVersion: cert-manager.io/v1alpha2
</span><span class="s">kind: Certificate
</span><span class="s">metadata:
</span><span class="s">  name: istio-web-certs
</span><span class="s">  namespace: istio-system
</span><span class="s">spec:
</span><span class="s">  dnsNames:
</span><span class="s">    - web.yoursite.com
</span><span class="s">  secretName: acme-web-yoursite-secret
</span><span class="s">  issuerRef:
</span><span class="s">    name: cloudflare-letsencrypt-prod
</span><span class="s">    kind: ClusterIssuer
</span><span class="s">EOF</span>

kubectl apply -f web-yoursite-com-cert.yaml
</code></pre></div><p>Note: it is easy to check the progress and issues of this certificate&rsquo;s signing:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">kubectl get certificaterequest
kubectl describe certificaterequest <span class="o">{</span>cert request name<span class="o">}</span>
kubectl describe order <span class="o">{</span>order name<span class="o">}</span>
kubectl describe challenge <span class="o">{</span>challenge name<span class="o">}</span>
</code></pre></div><p><img src="/images/istio2.png" alt="/images/istio2.png"  />
</p>
<h2 id="ingress">Ingress</h2>
<p>It&rsquo;s still not reachable. We need to add a virtual service</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">cat <span class="s">&lt;&lt;EOF &gt; cfr-virtual-service.yaml
</span><span class="s">apiVersion: networking.istio.io/v1alpha3
</span><span class="s">kind: VirtualService
</span><span class="s">metadata:
</span><span class="s">  name: bookinfo
</span><span class="s">spec:
</span><span class="s">  hosts:
</span><span class="s">  - &#34;web.yoursite.com&#34;
</span><span class="s">  gateways:
</span><span class="s">  - bookinfo-gateway
</span><span class="s">  http:
</span><span class="s">  - match:
</span><span class="s">    - uri:
</span><span class="s">        exact: /productpage
</span><span class="s">    - uri:
</span><span class="s">        prefix: /static
</span><span class="s">    - uri:
</span><span class="s">        exact: /login
</span><span class="s">    - uri:
</span><span class="s">        exact: /logout
</span><span class="s">    - uri:
</span><span class="s">        prefix: /api/v1/products
</span><span class="s">    route:
</span><span class="s">    - destination:
</span><span class="s">        host: productpage
</span><span class="s">        port:
</span><span class="s">          number: 9080
</span><span class="s">EOF</span>

kubectl apply -f cfr-virtual-service.yaml
</code></pre></div><p>And now the most important piece: our gateway</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">cat <span class="s">&lt;&lt;EOF &gt; cfr-gateway.yaml
</span><span class="s">apiVersion: networking.istio.io/v1alpha3
</span><span class="s">kind: Gateway
</span><span class="s">metadata:
</span><span class="s">  name: bookinfo-gateway
</span><span class="s">  namespace: default
</span><span class="s">spec:
</span><span class="s">  selector:
</span><span class="s">    istio: ingressgateway
</span><span class="s">  servers:
</span><span class="s">  - port:
</span><span class="s">      number: 443
</span><span class="s">      name: httpz-bookinfo
</span><span class="s">      protocol: HTTPS
</span><span class="s">    hosts:
</span><span class="s">    - &#34;web.yoursite.com&#34;
</span><span class="s">    tls:
</span><span class="s">      credentialName: acme-web-yoursite-secret
</span><span class="s">      mode: SIMPLE
</span><span class="s">      privateKey: sds
</span><span class="s">      serverCertificate: sds
</span><span class="s">EOF</span>

kubectl apply -f cfr-gateway.yaml
</code></pre></div><p>Check that our gateway is alive and well</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">kubectl -n istio-system describe pod/istio-ingressgateway-<span class="o">{</span>etc<span class="o">}</span>
kubectl -n istio-system logs pod/istio-ingressgateway-<span class="o">{</span>etc<span class="o">}</span>
</code></pre></div><p>Finally, since we do not have an actual load balancer available, let&rsquo;s add some port forwarding:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">export</span> <span class="nv">INGRESS_PORT</span><span class="o">=</span><span class="k">$(</span>kubectl -n istio-system get service istio-ingressgateway -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.spec.ports[?(@.name==&#34;http2&#34;)].nodePort}&#39;</span><span class="k">)</span>
<span class="nb">export</span> <span class="nv">SECURE_INGRESS_PORT</span><span class="o">=</span><span class="k">$(</span>kubectl -n istio-system get service istio-ingressgateway -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.spec.ports[?(@.name==&#34;https&#34;)].nodePort}&#39;</span><span class="k">)</span>
<span class="nb">export</span> <span class="nv">INGRESS_HOST</span><span class="o">=</span><span class="k">$(</span>kubectl get po -l <span class="nv">istio</span><span class="o">=</span>ingressgateway -n istio-system -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.items[0].status.hostIP}&#39;</span><span class="k">)</span>

sudo socat tcp-listen:443,reuseaddr,fork tcp:<span class="nv">$INGRESS_HOST</span>:<span class="nv">$SECURE_INGRESS_PORT</span> <span class="p">&amp;</span>
sudo socat tcp-listen:80,reuseaddr,fork tcp:<span class="nv">$INGRESS_HOST</span>:<span class="nv">$INGRESS_PORT</span> <span class="p">&amp;</span>
</code></pre></div><h2 id="footnotes">Footnotes</h2>
<p>Note:the clusterissuer has no selector, therefore it is used to issue certs for everyone!
We could have been more subtle:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">selector:
        matchLabels:
          <span class="s2">&#34;use-cloudflare-solver&#34;</span>: <span class="s2">&#34;true&#34;</span>
          <span class="s2">&#34;email&#34;</span>: <span class="s2">&#34;user@example.com&#34;</span>
selector:
        dnsNames:
        - <span class="s1">&#39;example.com&#39;</span>
        - <span class="s1">&#39;*.example.com&#39;</span>
selector:
        dnsZones:
        - <span class="s1">&#39;example.com&#39;</span>
</code></pre></div><p>Could we now update its gateway so that is supports both TLS and not TLS? Yes:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">cat <span class="s">&lt;&lt;EOF &gt; cfr-gateway.yaml
</span><span class="s">apiVersion: networking.istio.io/v1alpha3
</span><span class="s">kind: Gateway
</span><span class="s">metadata:
</span><span class="s">  name: bookinfo-gateway
</span><span class="s">  namespace: default
</span><span class="s">spec:
</span><span class="s">  selector:
</span><span class="s">    istio: ingressgateway
</span><span class="s">  servers:
</span><span class="s">  - port:
</span><span class="s">      number: 443
</span><span class="s">      name: httpz-bookinfo
</span><span class="s">      protocol: HTTPS
</span><span class="s">    hosts:
</span><span class="s">    - &#34;web.yoursite.com&#34;
</span><span class="s">    tls:
</span><span class="s">      credentialName: acme-web-yoursite-secret
</span><span class="s">      mode: SIMPLE
</span><span class="s">      privateKey: sds
</span><span class="s">      serverCertificate: sds
</span><span class="s">  - port:
</span><span class="s">      number: 80
</span><span class="s">      name: http-bookinfo
</span><span class="s">      protocol: HTTP
</span><span class="s">    hosts:
</span><span class="s">    - &#34;web.yoursite.com&#34;
</span><span class="s">EOF</span>
</code></pre></div><p>But could we redirect http to https? Yes using <code>tls/httpsRedirect</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">cat <span class="s">&lt;&lt;EOF &gt; cfr-gateway.yaml
</span><span class="s">apiVersion: networking.istio.io/v1alpha3
</span><span class="s">kind: Gateway
</span><span class="s">metadata:
</span><span class="s">  name: bookinfo-gateway
</span><span class="s">  namespace: default
</span><span class="s">spec:
</span><span class="s">  selector:
</span><span class="s">    istio: ingressgateway
</span><span class="s">  servers:
</span><span class="s">  - port:
</span><span class="s">      number: 443
</span><span class="s">      name: httpz-bookinfo
</span><span class="s">      protocol: HTTPS
</span><span class="s">    hosts:
</span><span class="s">    - &#34;web.yoursite.com&#34;
</span><span class="s">    tls:
</span><span class="s">      credentialName: acme-web-yoursite-secret
</span><span class="s">      mode: SIMPLE
</span><span class="s">      privateKey: sds
</span><span class="s">      serverCertificate: sds
</span><span class="s">  - port:
</span><span class="s">      number: 80
</span><span class="s">      name: http-bookinfo
</span><span class="s">      protocol: HTTP
</span><span class="s">    tls:
</span><span class="s">      httpsRedirect: true
</span><span class="s">    hosts:
</span><span class="s">    - &#34;web.yoursite.com&#34;
</span><span class="s">EOF</span>
</code></pre></div><h2 id="the-big-undo">The Big Undo</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">sudo killall socat
<span class="k">for</span> app in productpage reviews ratings details<span class="p">;</span> <span class="k">do</span>
	kubectl delete all -l <span class="nv">app</span><span class="o">=</span><span class="nv">$app</span> -n default
<span class="k">done</span>
kubectl delete ns cert-manager istio-system
<span class="nv">CRDNAME</span><span class="o">=</span>istiooperators.install.istio.io
<span class="k">for</span> a in <span class="k">$(</span>k get crd <span class="p">|</span> grep istio <span class="p">|</span> awk <span class="s1">&#39;{print $1}&#39;</span><span class="k">)</span><span class="p">;</span> <span class="k">do</span> k delete crd <span class="nv">$a</span><span class="p">;</span> <span class="k">done</span>
kubectl patch crd/<span class="si">${</span><span class="nv">CRDNAME</span><span class="si">}</span> -p <span class="s1">&#39;{&#34;metadata&#34;:{&#34;finalizers&#34;:[]}}&#39;</span> --type<span class="o">=</span>merge
<span class="k">for</span> a in <span class="k">$(</span>k get crd <span class="p">|</span> grep cert-manager <span class="p">|</span> awk <span class="s1">&#39;{print $1}&#39;</span><span class="k">)</span><span class="p">;</span> <span class="k">do</span> k delete crd <span class="nv">$a</span><span class="p">;</span> <span class="k">done</span>

</code></pre></div>
                        </div>
                        <aside class="lg:block tableOfContentContainer border-indigo-200" id="tableOfContentContainer">
                        <h3>Contents</h3>
                        <nav id="TableOfContents">
  <ul>
    <li><a href="#what-is-this">What is this?</a></li>
    <li><a href="#a-few-useful-concepts-before-we-get-started">A few useful concepts before we get started</a>
      <ul>
        <li><a href="#gateways-and-ingress">&ldquo;Gateways&rdquo; and &ldquo;Ingress&rdquo;</a></li>
        <li><a href="#setting-up">Setting up</a></li>
        <li><a href="#using-a-load-balancer-spoiler-i-will-not">Using a load balancer (spoiler: I will not)</a></li>
        <li><a href="#node-port-approach">Node Port approach</a></li>
        <li><a href="#sidecar-injection">Sidecar Injection</a></li>
        <li><a href="#the-ingress-in-the-ingress">The ingress in the ingress</a></li>
        <li><a href="#what-changed-in-1516">What changed in 1.5/1.6&hellip;?</a></li>
      </ul>
    </li>
    <li><a href="#tutorial">Tutorial</a>
      <ul>
        <li><a href="#cert-manager">cert-manager</a></li>
        <li><a href="#letsencrypt-and-cloudflare">Letsencrypt and Cloudflare</a></li>
        <li><a href="#hello-istio">Hello, istio</a></li>
        <li><a href="#ingress">Ingress</a></li>
        <li><a href="#footnotes">Footnotes</a></li>
        <li><a href="#the-big-undo">The Big Undo</a></li>
      </ul>
    </li>
  </ul>
</nav>
                        </aside>
                    </main>
                
              </section>

              
              <script>talkyardServerUrl='https:\/\/comments-for-nexus-zteo-com.talkyard.net';</script>
              <script async defer src="https://c1.ty-cdn.net/-/talkyard-comments.min.js"></script>
              
              <div class="talkyard-comments" data-discussion-id="" style="margin-top: 45px;">
                  <noscript>Please enable Javascript to view comments.</noscript>
                  <p style="margin-top: 25px; opacity: 0.9; font-size: 96%">Comments powered by
                  <a href="https://www.talkyard.io">Talkyard</a>.</p>
              </div>
              

              <footer class="post-footer">
                  <div class="post-tags">
            
            
                <a href="https://zteo.com/tags/kubernetes">kubernetes</a>
            
                <a href="https://zteo.com/tags/service-mesh">service mesh</a>
            
            
                  </div>
                
                
                    <div class="post-share">
                        <a class="fa fa-reddit-alien" href="//www.reddit.com/submit" onclick="window.location = '//www.reddit.com/submit?url=' + encodeURIComponent(window.location); return false">
                            <span>Reddit</span>
                        </a>
                        <a class="fa fa-twitter" href="https://twitter.com/share?text=Istio%2c%20Cert-Manager%20and%20Let%27s%20Encrypt%20April%20%2720&url=https%3a%2f%2fzteo.com%2fposts%2fistio-and-cert-manager-and-lets-encrypt%2f" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                            <span>Twitter</span>
                        </a>
                    </div>
                
            
              </footer>

            
                <aside class="post-comments">
    
    
    
</aside>

            
            </div>

            <nav class="post-nav">
                
                    <a class="post-nav-item post-nav-next" href="https://zteo.com/posts/kiali-and-your-mesh/">
                        <section class="post-nav-teaser">
                            <span class="post-nav-icon"><i class="fa fa-chevron-left"></i></span>
                            <span class="post-nav-info">
                                <h4 class="post-nav-title">Setup Kiali, Analyse Your Mesh</h4>
                            </span>
                        </section>
                    </a>
                
                
                    <a class="post-nav-item post-nav-prev" href="https://zteo.com/posts/decoy-pricing-bloomberg/">
                        <section class="post-nav-teaser">
                            <span class="post-nav-icon"><i class="fa fa-chevron-right"></i></span>
                            <span class="post-nav-info">
                                <h4 class="post-nav-title">Fixing Vmware Fusion Broken Vmmon</h4>
                            </span>
                        </section>
                    </a>
                
                <div class="clear"></div>
            </nav>

        </div>
    </article>
</main>
<script>
window.addEventListener('DOMContentLoaded', () => {
    const observerForTableOfContentActiveState = new IntersectionObserver(entries => {
        entries.forEach(entry => {
            const id = entry.target.getAttribute('id');

            if (entry.intersectionRatio > 0) {
                clearActiveStatesInTableOfContents();
                document.querySelector(`aside nav li a[href="#${id}"]`).parentElement.classList.add('active');
            }
        });
    });

    document.querySelectorAll('h1[id],h2[id],h3[id],h4[id]').forEach((section) => {
        observerForTableOfContentActiveState.observe(section);
    });
});

function clearActiveStatesInTableOfContents() {
    document.querySelectorAll('aside nav li').forEach((section) => {
        section.classList.remove('active');
    });
}
</script>

                <div id="body-class" style="display: none;"></div>
                <footer id="footer">
                    <section class="credits">
                        <span class="credits-license"><i class="fa fa-copyright"></i>2021 The Nexus
                    </span>
                    </section>
                </footer>
                

                

                
                <div class="overlay"></div>
            </div>
        </section>

<video autoplay loop id="video-background" muted plays-inline>
<source src="https://zteo.com/images/hd0198.mp4" type="video/mp4">
</video>

<script src="/mermaid/mermaid.js?1636583495"></script>
<script async src="https://zteo.com//js/main.js"></script>
<script async src="https://zteo.com//js/basicLightbox.min.js"></script>

<script>


function defer(method) {
    if (window.jQuery) {
        method();
    } else {
        setTimeout(function() { defer(method) }, 50);
    }
}
defer(function() {
    jQuery.fn.doubleTapToGo = function( params ) {
        if( !( 'ontouchstart' in window ) &&
            !navigator.msMaxTouchPoints &&
            !navigator.userAgent.toLowerCase().match( /windows phone os 7/i ) ) return false;

        this.each( function()
        {
            var curItem = false;

            jQuery( this ).on( 'click', function( e )
            {
                var item = jQuery( this );
                if( item[ 0 ] != curItem[ 0 ] )
                {
                    e.preventDefault();
                    curItem = item;
                }
            });

            jQuery( document ).on( 'click touchstart MSPointerDown', function( e )
            {
                var resetItem = true,
                    parents	  = jQuery( e.target ).parents();

                for( var i = 0; i < parents.length; i++ )
                    if( parents[ i ] == curItem[ 0 ] )
                        resetItem = false;

                if( resetItem )
                    curItem = false;
            });
        });
        return this;
    };
    jQuery( '#nav li:has(ul)' ).doubleTapToGo();
});
</script>

<script>
    mermaid.initialize({ startOnLoad: true });
</script>




  <noscript><link rel="stylesheet" href="https://zteo.com//css/main.css"></noscript>
</body>
</html>

